name: Kotlin Tip Notification

on:
  push:
    branches:
      - main  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    paths:
      - '**/*.md'  # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì¶”ê°€
  workflow_dispatch:
    inputs:
      tip_path:
        description: 'ì•Œë¦¼ì„ ë³´ë‚¼ íŒ íŒŒì¼ ê²½ë¡œ (ì˜ˆ: 01-ê¸°ë³¸-ë¬¸ë²•ê³¼-íƒ€ì…-ì‹œìŠ¤í…œ/01-null-ì•ˆì „ì„±-ì•ˆì „-í˜¸ì¶œ-ì—°ì‚°ì.md)'
        required: true
        type: string

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ í•„ìš”

      - name: Get changed files (for push event)
        id: changed-files
        if: github.event_name == 'push'
        uses: tj-actions/changed-files@v35
        with:
          files: '**/*.md'  # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë§Œ í™•ì¸

      - name: Set tip files for manual trigger
        id: manual-tip
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "files=${{ github.event.inputs.tip_path }}" >> $GITHUB_OUTPUT
          echo "ìˆ˜ë™ íŠ¸ë¦¬ê±° íŒŒì¼ ê²½ë¡œ: ${{ github.event.inputs.tip_path }}"
          ls -la
          if [ -f "${{ github.event.inputs.tip_path }}" ]; then
            echo "íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
          fi

      - name: Find new or modified tip files
        id: find-tips
        run: |
          TIPS=""
          
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ íŒŒì¼ ëª©ë¡ ì‚¬ìš©
          if [[ "${{ github.event_name }}" == "push" ]]; then
            FILES="${{ steps.changed-files.outputs.all_changed_files }}"
            echo "í‘¸ì‹œ ì´ë²¤íŠ¸ íŒŒì¼ ëª©ë¡: $FILES"
          else
            FILES="${{ steps.manual-tip.outputs.files }}"
            echo "ìˆ˜ë™ íŠ¸ë¦¬ê±° íŒŒì¼ ëª©ë¡: $FILES"
          fi
          
          # ë””ë²„ê¹…ì„ ìœ„í•œ ì¶œë ¥
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la
          
          for file in $FILES; do
            echo "ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼: $file"
            
            if [[ -f "$file" ]]; then
              echo "íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
              
              if [[ $file == *".md" ]]; then
                echo "ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì…ë‹ˆë‹¤."
                
                if [[ $file == *"ê¸°ë³¸-ë¬¸ë²•ê³¼-íƒ€ì…-ì‹œìŠ¤í…œ"* || $file == *"í•¨ìˆ˜ì™€-ëŒë‹¤"* || $file == *"ì»¬ë ‰ì…˜ê³¼-í•¨ìˆ˜í˜•-í”„ë¡œê·¸ë˜ë°"* || $file == *"ìŠ¤ì½”í”„-í•¨ìˆ˜"* || $file == *"í´ë˜ìŠ¤ì™€-ê°ì²´"* || $file == *"í™•ì¥-ê¸°ëŠ¥"* || $file == *"ì½”ë£¨í‹´-ê¸°ì´ˆ"* || $file == *"ì½”ë£¨í‹´-ê³ ê¸‰"* || $file == *"ìƒí˜¸ìš´ìš©ì„±ê³¼-ë„êµ¬"* || $file == *"ì‹¤ìš©ì ì¸-íŒ"* ]]; then
                  echo "íŒ íŒŒì¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤."
                  
                  # íŒŒì¼ ì´ë¦„ì—ì„œ ìˆ«ìì™€ í•˜ì´í”ˆ ì œê±°í•˜ê³  ì²« ê¸€ìë§Œ ëŒ€ë¬¸ìë¡œ ë³€í™˜
                  TIP_NAME=$(basename "$file" .md | sed -E 's/^[0-9]+-//' | sed -E 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
                  echo "íŒ ì´ë¦„: $TIP_NAME"
                  
                  # íŒŒì¼ ë‚´ìš©ì—ì„œ ì²« ë²ˆì§¸ í—¤ë”© ì¶”ì¶œ
                  HEADING=$(grep -m 1 "^# " "$file" | sed 's/^# //')
                  echo "í—¤ë”©: $HEADING"
                  
                  # íŒŒì¼ ê²½ë¡œì™€ ì œëª© ì €ì¥
                  if [ -n "$HEADING" ]; then
                    TIPS="$TIPS\nâ€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$HEADING>"
                  else
                    TIPS="$TIPS\nâ€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$TIP_NAME>"
                  fi
                else
                  echo "íŒ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤."
                fi
              else
                echo "ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤."
              fi
            else
              echo "íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            fi
          done
          
          echo "ìµœì¢… íŒ ëª©ë¡: $TIPS"
          
          if [ -z "$TIPS" ]; then
            echo "No tip files were found."
            echo "has_tips=false" >> $GITHUB_OUTPUT
          else
            echo "has_tips=true" >> $GITHUB_OUTPUT
            echo "tips<<EOF" >> $GITHUB_OUTPUT
            echo -e "$TIPS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Debug outputs
        run: |
          echo "has_tips ê°’: ${{ steps.find-tips.outputs.has_tips }}"
          echo "tips ê°’: ${{ steps.find-tips.outputs.tips }}"

      - name: Send notification to Slack
        if: steps.find-tips.outputs.has_tips == 'true'
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.event_name == 'push' && 'ğŸ‰ ìƒˆë¡œìš´ Kotlin íŒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!' || 'ğŸ“¢ ì˜¤ëŠ˜ì˜ Kotlin íŒì„ í™•ì¸í•˜ì„¸ìš”!' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ github.event_name == 'push' && 'ë‹¤ìŒ Kotlin íŒì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:' || 'ì˜¤ëŠ˜ì˜ Kotlin íŒ:' }}\n${{ steps.find-tips.outputs.tips }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}|ì €ì¥ì†Œ ë°©ë¬¸í•˜ê¸°> | <https://github.com/${{ github.repository }}/issues|ì´ìŠˆ ì œë³´í•˜ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
