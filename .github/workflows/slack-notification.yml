name: Kotlin Tip Notification

on:
  push:
    branches:
      - main  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì¶”ê°€
  workflow_dispatch:
    inputs:
      tip_path:
        description: 'ì•Œë¦¼ì„ ë³´ë‚¼ íŒ íŒŒì¼ ê²½ë¡œ (ì˜ˆ: tips/01-basic-syntax-and-type-system/01-null-safety-safe-call-operator.md)'
        required: true
        type: string

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ í•„ìš”

      - name: Debug environment
        run: |
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Event Name: ${{ github.event_name }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "Current directory:"
          ls -la

      - name: Find tip files from commit
        id: find-tips-from-commit
        if: github.event_name == 'push'
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ íŒ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # ìµœê·¼ ì»¤ë°‹ì—ì„œ ì¶”ê°€/ìˆ˜ì •ëœ ëª¨ë“  íŒŒì¼ ì°¾ê¸°
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          echo "All changed files:"
          echo "$CHANGED_FILES"
          
          # íŒ íŒŒì¼ ì§ì ‘ ì°¾ê¸° (tips ë””ë ‰í† ë¦¬ ë‚´ì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼)
          TIP_FILES=""
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ ìˆœíšŒí•˜ë©° íŒ íŒŒì¼ ì°¾ê¸°
          for file in $CHANGED_FILES; do
            echo "Checking file: $file"
            # tips ë””ë ‰í† ë¦¬ ë‚´ì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë§Œ í•„í„°ë§
            if [[ "$file" == tips/* && "$file" == *.md ]]; then
              echo "Found tip file: $file"
              TIP_FILES="$TIP_FILES $file"
            fi
          done
          
          echo "Tip files: $TIP_FILES"
          
          # TIP_FILESê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ has_tips=true ì„¤ì •
          if [[ -n "$TIP_FILES" ]]; then
            echo "has_tips=true" >> $GITHUB_OUTPUT
            echo "tip_files=$TIP_FILES" >> $GITHUB_OUTPUT
          else
            echo "has_tips=false" >> $GITHUB_OUTPUT
          fi

      - name: Set tip files for manual trigger
        id: manual-tip
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "tip_files=${{ github.event.inputs.tip_path }}" >> $GITHUB_OUTPUT
          echo "has_tips=true" >> $GITHUB_OUTPUT
          echo "Manual trigger file path: ${{ github.event.inputs.tip_path }}"

      - name: Process tip files
        id: process-tips
        if: (github.event_name == 'push' && steps.find-tips-from-commit.outputs.has_tips == 'true') || github.event_name == 'workflow_dispatch'
        run: |
          TIPS=""
          
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ íŒŒì¼ ëª©ë¡ ì‚¬ìš©
          if [[ "${{ github.event_name }}" == "push" ]]; then
            FILES="${{ steps.find-tips-from-commit.outputs.tip_files }}"
            echo "Processing push event files: $FILES"
          else
            FILES="${{ steps.manual-tip.outputs.tip_files }}"
            echo "Processing manual trigger files: $FILES"
          fi
          
          # ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
          echo "Current directory contents:"
          ls -la
          
          for file in $FILES; do
            echo "Processing file: $file"
            
            if [[ -f "$file" ]]; then
              echo "File exists"
              
              # íŒŒì¼ ë‚´ìš©ì—ì„œ ì²« ë²ˆì§¸ í—¤ë”© ì¶”ì¶œ
              HEADING=$(grep -m 1 "^# " "$file" | sed 's/^# //')
              echo "Extracted heading: $HEADING"
              
              # íŒŒì¼ ê²½ë¡œì™€ ì œëª© ì €ì¥ (ê°œí–‰ ì¶”ê°€)
              if [ -n "$HEADING" ]; then
                if [ -n "$TIPS" ]; then
                  TIPS="$TIPS\nâ€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$HEADING>"
                else
                  TIPS="â€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$HEADING>"
                fi
              else
                # í—¤ë”©ì´ ì—†ìœ¼ë©´ íŒŒì¼ ì´ë¦„ ì‚¬ìš©
                TIP_NAME=$(basename "$file" .md | sed -E 's/^[0-9]+-//' | sed -E 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
                if [ -n "$TIPS" ]; then
                  TIPS="$TIPS\nâ€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$TIP_NAME>"
                else
                  TIPS="â€¢ <https://github.com/${{ github.repository }}/blob/main/$file|$TIP_NAME>"
                fi
              fi
              echo "Current tips list: $TIPS"
            else
              echo "File does not exist: $file"
            fi
          done
          
          if [ -z "$TIPS" ]; then
            echo "No tip files were found."
            echo "has_tips=false" >> $GITHUB_OUTPUT
          else
            echo "has_tips=true" >> $GITHUB_OUTPUT
            echo "tips=$TIPS" >> $GITHUB_OUTPUT
          fi

      - name: Debug outputs
        run: |
          echo "has_tips (push): ${{ steps.find-tips-from-commit.outputs.has_tips }}"
          echo "has_tips (process): ${{ steps.process-tips.outputs.has_tips }}"
          echo "tips: ${{ steps.process-tips.outputs.tips }}"

      - name: Create Slack message file
        if: steps.process-tips.outputs.has_tips == 'true'
        run: |
          cat > slack_message.json << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ github.event_name == 'push' && 'ğŸ‰ ìƒˆë¡œìš´ Kotlin íŒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!' || 'ğŸ“¢ ì˜¤ëŠ˜ì˜ Kotlin íŒ' }}",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ steps.process-tips.outputs.tips }}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}|ì €ì¥ì†Œ ë°©ë¬¸í•˜ê¸°> | <https://github.com/${{ github.repository }}/issues|ì´ìŠˆ ì œë³´í•˜ê¸°>"
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "Created Slack message file:"
          cat slack_message.json

      - name: Send notification to Slack
        if: steps.process-tips.outputs.has_tips == 'true'
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload-file-path: slack_message.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
